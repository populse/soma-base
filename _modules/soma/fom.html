
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>soma.fom &#8212; Soma-base 5.1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Soma-base 5.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">soma.fom</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for soma.fom</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">File Organization Model (FOM)</span>
<span class="sd">=============================</span>

<span class="sd">A FOM is a JSON file (dictionary) describing how to make filenames from a set of attributes.</span>

<span class="sd">FOM definition</span>
<span class="sd">--------------</span>

<span class="sd">Ex::</span>

<span class="sd">    {</span>
<span class="sd">        &quot;fom_name&quot;: &quot;morphologist-auto-nonoverlap-1.0&quot;,</span>

<span class="sd">        &quot;fom_import&quot;: [&quot;formats-brainvisa-1.0&quot;, &quot;brainvisa-formats-3.2.0&quot;,</span>
<span class="sd">                      &quot;shared-brainvisa-1.0&quot;],</span>

<span class="sd">        &quot;attribute_definitions&quot; : {</span>
<span class="sd">          &quot;acquisition&quot; : {&quot;default_value&quot; : &quot;default_acquisition&quot;},</span>
<span class="sd">          &quot;analysis&quot; : {&quot;default_value&quot; : &quot;default_analysis&quot;},</span>
<span class="sd">          &quot;sulci_recognition_session&quot; :  {&quot;default_value&quot; : &quot;default_session&quot;},</span>
<span class="sd">          &quot;graph_version&quot;: {&quot;default_value&quot;: &quot;3.1&quot;},</span>
<span class="sd">        },</span>

<span class="sd">        &quot;shared_patterns&quot;: {</span>
<span class="sd">          &quot;acquisition&quot;: &quot;&lt;center&gt;/&lt;subject&gt;/t1mri/&lt;acquisition&gt;&quot;,</span>
<span class="sd">          &quot;analysis&quot;: &quot;{acquisition}/&lt;analysis&gt;&quot;,</span>
<span class="sd">          &quot;recognition_analysis&quot;: &quot;{analysis}/folds/&lt;graph_version&gt;/&lt;sulci_recognition_session&gt;_auto&quot;,</span>
<span class="sd">        },</span>

<span class="sd">        &quot;processes&quot; : {</span>
<span class="sd">            &quot;Morphologist&quot; : {</span>
<span class="sd">                &quot;t1mri&quot;:</span>
<span class="sd">                    [[&quot;input:{acquisition}/&lt;subject&gt;&quot;, &quot;images&quot;],</span>
<span class="sd">                &quot;imported_t1mri&quot;:</span>
<span class="sd">                    [[&quot;output:{acquisition}/&lt;subject&gt;&quot;, &quot;images&quot;]],</span>
<span class="sd">                &quot;t1mri_referential&quot;:</span>
<span class="sd">                    [[&quot;output:{acquisition}/registration/RawT1-&lt;subject&gt;_&lt;acquisition&gt;&quot;, &quot;Referential&quot;]],</span>
<span class="sd">                &quot;reoriented_t1mri&quot;:</span>
<span class="sd">                    [[&quot;output:{acquisition}/&lt;subject&gt;&quot;, &quot;images&quot;]],</span>
<span class="sd">                &quot;t1mri_nobias&quot;:</span>
<span class="sd">                    [[&quot;output:{analysis}/nobias_&lt;subject&gt;&quot;, &quot;images&quot; ]],</span>
<span class="sd">                &quot;split_brain&quot;:</span>
<span class="sd">                    [[&quot;output:{analysis}/segmentation/voronoi_&lt;subject&gt;&quot;,&quot;images&quot;]],</span>
<span class="sd">                &quot;left_graph&quot;:</span>
<span class="sd">                    [[&quot;output:{analysis}/folds/&lt;graph_version&gt;/&lt;side&gt;&lt;subject&gt;&quot;,</span>
<span class="sd">                        &quot;Graph and data&quot;,</span>
<span class="sd">                        {&quot;side&quot;: &quot;L&quot;, &quot;labelled&quot;: &quot;No&quot;}]],</span>
<span class="sd">                &quot;left_labelled_graph&quot;:</span>
<span class="sd">                    [[&quot;output:{recognition_analysis}/&lt;side&gt;&lt;subject&gt;_&lt;sulci_recognition_session&gt;_auto&quot;,</span>
<span class="sd">                        &quot;Graph and data&quot;, {&quot;side&quot;: &quot;L&quot;}]],</span>
<span class="sd">                &quot;right_graph&quot;:</span>
<span class="sd">                    [[&quot;output:{analysis}/folds/&lt;graph_version&gt;/&lt;side&gt;&lt;subject&gt;&quot;,</span>
<span class="sd">                        &quot;Graph and data&quot;, {&quot;side&quot;:&quot;R&quot;,&quot;labelled&quot;:&quot;No&quot;}]],</span>
<span class="sd">                &quot;right_labelled_graph&quot;:</span>
<span class="sd">                    [[&quot;output:{recognition_analysis}/&lt;side&gt;&lt;subject&gt;_&lt;sulci_recognition_session&gt;_auto&quot;,</span>
<span class="sd">                        &quot;Graph and data&quot;, {&quot;side&quot;: &quot;R&quot;}]],</span>
<span class="sd">                &quot;Talairach_transform&quot;:</span>
<span class="sd">                    [[&quot;output:{acquisition}/registration/RawT1-&lt;subject&gt;_&lt;acquisition&gt;_TO_Talairach-ACPC&quot;,</span>
<span class="sd">                        &quot;Transformation matrix&quot;]]</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">    }</span>

<span class="sd">The dictionary may contain:</span>

<span class="sd">**fom_name**: string</span>
<span class="sd">    identifier of the FOM model. Several FOMs may coexist under different</span>
<span class="sd">    identifiers.</span>

<span class="sd">**fom_import**: list</span>
<span class="sd">    dependencies between FOMs. A Fom may import others to benefit from its</span>
<span class="sd">    formats, patterns etc.</span>

<span class="sd">**attribute_definitions**: dict</span>
<span class="sd">    a dict of predefines attributes. It is generally used to define default</span>
<span class="sd">    values for some attributes. Each attribute defined here is also a dict. In</span>
<span class="sd">    this sub-dict, the key &quot;default_value&quot; provides the attribute default</span>
<span class="sd">    value.</span>

<span class="sd">    Attributes don&#39;t *need* to be defined here, they are automatically defined</span>
<span class="sd">    as they are used in path patterns. But here we can assign them additional</span>
<span class="sd">    information (typically default values).</span>

<span class="sd">**shared_patterns**: dict</span>
<span class="sd">    mapping of reusable patterns. Such patterns will be replaced with their</span>
<span class="sd">    contents when used in the file paths patterns. To use such a pattern, place</span>
<span class="sd">    it with brackets {} in file paths patterns::</span>

<span class="sd">        &quot;input:{acquisition}/&lt;subject&gt;&quot;</span>

<span class="sd">    here ``{aquisition}`` is the *shared pattern* &quot;aquisition&quot;, and</span>
<span class="sd">    ``&lt;subject&gt;`` is the *attribute* &quot;subject&quot;</span>

<span class="sd">    A pattern definition may also use attributes between ``&lt;attribute_name&gt;``</span>
<span class="sd">    quotes, and / or reuse other patterns between ``{pattern}`` curly brackets.</span>

<span class="sd">**processes**: dict</span>
<span class="sd">    dictionary of processes supported by the FOM, and path definitions for</span>
<span class="sd">    their parameters. The dict is organized by process, then in each process a</span>
<span class="sd">    sub-dict contains its parameters definitions. For a given parameter, a list</span>
<span class="sd">    of the FOM rules is given: several rules are allowed.</span>

<span class="sd">    Process names keys may be a fully qualified module/class name, or a short</span>
<span class="sd">    identifier, or a &quot;contextual&quot; name: the name a process has in the context</span>
<span class="sd">    of a pipeline.</span>

<span class="sd">    A FOM rule is a list of 2 or 3 elements::</span>

<span class="sd">        [patterrn, formats, attributes]</span>

<span class="sd">    *pattern*: string</span>
<span class="sd">        the FOM pattern for the file path of the given parameter. A pattern</span>
<span class="sd">        starts with a directory identifier (``input``, ``output``,</span>
<span class="sd">        ``shared``), followed by a semicolon (``:``), and a file pattern which</span>
<span class="sd">        may contain attributes (``&lt;attrib&gt;``) and/or shared patterns</span>
<span class="sd">        (``{pattern}``). Ex::</span>

<span class="sd">            &quot;input:{acquisition}/&lt;subject&gt;&quot;</span>

<span class="sd">    *formats*: string or list</span>
<span class="sd">        name of a format, a formats list, or a list of allowed formats names.</span>
<span class="sd">        The formats will rule the possible file extensions.</span>

<span class="sd">    *attributes*: dict, optional</span>
<span class="sd">        An optional dict assigning locally some attributes values. Ex::</span>

<span class="sd">            {&quot;side&quot;: &quot;left&quot;}</span>

<span class="sd">        The attributes values here are used both to replace attributes values in the current file path pattern, and to select the matching rule when attributes values are given externally (hm, to be checked actually).</span>

<span class="sd">A FOM file is a JSON file (actually a JSON/YAML extended file, to allow comments within it), which should be placed in a common directory where the FOM manager will look for it (``share/foms/``)</span>

<span class="sd">How to use FOMS</span>
<span class="sd">---------------</span>

<span class="sd">At higher level, they are used for instance in `CAPSUL &lt;http://brainvisa.info/capsul/&gt;`_.</span>

<span class="sd">At lower level, they are used through several classes:</span>

<span class="sd">* :class:`FileOrganizationModelManager` manages a set of FOMs, looks for them in a search path, reads them.</span>
<span class="sd">* :class:`FileOrganizationModels` represents a FOM rules set.</span>
<span class="sd">* :class:`AttributesToPaths` is used to convert a set of attributes into filenames (which is the main use of FOMs).</span>
<span class="sd">* :class:`PathToAttributes` performs the reverse operation: match attributes and determines their values from a given filename.</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span> <span class="k">as</span> <span class="nn">osp</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">bz2</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">bz2</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">yaml</span>

<div class="viewcode-block" id="json_reader"><a class="viewcode-back" href="../../api.html#soma.fom.json_reader">[docs]</a>    <span class="k">class</span> <span class="nc">json_reader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This class has a single static method load that loads an</span>
<span class="sd">        JSON file with two features not provided by all JSON readers:</span>

<span class="sd">        - JSON syntax is extended. For instance comments are allowed.</span>
<span class="sd">        - The order of elements in dictionaries can be preserved by</span>
<span class="sd">          using parameter object_pairs_hook=OrderedDict (as in Python</span>
<span class="sd">          2.7 JSON reader).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nd">@staticmethod</span>
        <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="nb">dict</span><span class="p">):</span>
            <span class="k">class</span> <span class="nc">OrderedLoader</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">Loader</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="k">def</span> <span class="nf">construct_mapping</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
                <span class="n">loader</span><span class="o">.</span><span class="n">flatten_mapping</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">object_pairs_hook</span><span class="p">(</span><span class="n">loader</span><span class="o">.</span><span class="n">construct_pairs</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="n">OrderedLoader</span><span class="o">.</span><span class="n">add_constructor</span><span class="p">(</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">BaseResolver</span><span class="o">.</span><span class="n">DEFAULT_MAPPING_TAG</span><span class="p">,</span>
                <span class="n">construct_mapping</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">OrderedLoader</span><span class="p">)</span></div>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span> <span class="k">as</span> <span class="nn">json_reader</span>

<span class="kn">from</span> <span class="nn">soma.path</span> <span class="kn">import</span> <span class="n">split_path</span>

<div class="viewcode-block" id="deep_update"><a class="viewcode-back" href="../../api.html#soma.fom.deep_update">[docs]</a><span class="k">def</span> <span class="nf">deep_update</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">original</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Recursively update a dict.</span>
<span class="sd">    Subdict&#39;s won&#39;t be overwritten but also updated.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">original</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">update</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">deep_update</span><span class="p">(</span><span class="n">update</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">update</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;In deep_update, for key </span><span class="si">%s</span><span class="s1">, cannot merge </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">update</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span></div>


<div class="viewcode-block" id="read_json"><a class="viewcode-back" href="../../api.html#soma.fom.read_json">[docs]</a><span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Read a json-like file using yaml or json.</span>
<span class="sd">    In case of failure, issue a clearer message with filename, and when</span>
<span class="sd">    appropriate a warning about yaml not being installed.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json_reader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">object_pairs_hook</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">json_reader</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;yaml&#39;</span><span class="p">:</span>
            <span class="n">extra_msg</span> <span class="o">=</span> <span class="s1">&#39; Check your python installation, and perhaps un a &quot;pip install PyYAML&quot; or &quot;easy_install PyYAML&quot;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">. This may be due to yaml module not installed.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">extra_msg</span><span class="p">))</span></div>


<span class="k">class</span> <span class="nc">DirectoryAsDict</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DirectoryAsDict</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">cache</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">DirectoriesCache</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">cache</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;DirectoryAsDict( </span><span class="si">%s</span><span class="s1"> )&gt;&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">st_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">st_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">st_content</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">i</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">listdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">yield</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">:</span>
                <span class="n">full_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">st_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get_directory</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">st_content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">st_content</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">st</span><span class="p">),</span> <span class="n">DirectoryAsDict</span><span class="p">(</span><span class="n">full_path</span><span class="p">)])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">st</span><span class="p">),</span> <span class="kc">None</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DirectoryAsDict</span><span class="o">.</span><span class="n">_get_directory</span><span class="p">(</span>
            <span class="n">directory</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">directories</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span>
                       <span class="n">files_size</span><span class="p">,</span> <span class="n">path_size</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">listdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">listdir</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">debug</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> files=</span><span class="si">%d</span><span class="s1">, directories=</span><span class="si">%d</span><span class="s1">, size=</span><span class="si">%d</span><span class="s1">&#39;</span>
                               <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(),</span> <span class="n">files</span> <span class="o">+</span> <span class="n">links</span><span class="p">,</span> <span class="n">directories</span><span class="p">,</span>
                                  <span class="n">files_size</span><span class="p">))</span>
                <span class="n">path_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">full_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                    <span class="n">files</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">files_size</span> <span class="o">+=</span> <span class="n">st</span><span class="o">.</span><span class="n">st_size</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">st</span><span class="p">),</span> <span class="kc">None</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                    <span class="n">content</span><span class="p">,</span> <span class="n">directories</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">files_size</span><span class="p">,</span> \
                        <span class="n">path_size</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span>  \
                        <span class="n">DirectoryAsDict</span><span class="o">.</span><span class="n">_get_directory</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span>
                                                       <span class="n">directories</span> <span class="o">+</span>
                                                       <span class="mi">1</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">files_size</span><span class="p">,</span>
                                                       <span class="n">path_size</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">st</span><span class="p">),</span> <span class="n">content</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">links</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">st</span><span class="p">),</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">directories</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">files_size</span><span class="p">,</span> <span class="n">path_size</span><span class="p">,</span> \
            <span class="n">errors</span><span class="p">,</span> <span class="n">count</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">paths_to_dict</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="n">current_dir</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">path_list</span> <span class="o">=</span> <span class="n">split_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">st_content</span> <span class="o">=</span> <span class="n">current_dir</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">{}])</span>
                <span class="k">if</span> <span class="n">st_content</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">st_content</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">current_dir</span> <span class="o">=</span> <span class="n">st_content</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">current_dir</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">path_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="n">dirdict</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DirectoryAsDict</span><span class="o">.</span><span class="n">_get_statistics</span><span class="p">(</span>
            <span class="n">dirdict</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_statistics</span><span class="p">(</span><span class="n">dirdict</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">directories</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">files_size</span><span class="p">,</span>
                        <span class="n">path_size</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">count</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">debug</span> <span class="ow">and</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">debug</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> files=</span><span class="si">%d</span><span class="s1">, directories=</span><span class="si">%d</span><span class="s1">, size=</span><span class="si">%d</span><span class="s1">&#39;</span>
                       <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">(),</span> <span class="n">files</span> <span class="o">+</span> <span class="n">links</span><span class="p">,</span> <span class="n">directories</span><span class="p">,</span> <span class="n">files_size</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">dirdict</span><span class="p">):</span>
            <span class="n">path_size</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">st</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">if</span> <span class="n">st</span><span class="p">:</span>
                <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                    <span class="n">files</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">files_size</span> <span class="o">+=</span> <span class="n">st</span><span class="o">.</span><span class="n">st_size</span>
                <span class="k">elif</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">directories</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">directories</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">files_size</span><span class="p">,</span> <span class="n">path_size</span><span class="p">,</span> \
                            <span class="n">errors</span><span class="p">,</span> <span class="n">count</span> \
                            <span class="o">=</span> <span class="n">DirectoryAsDict</span><span class="o">.</span><span class="n">_get_statistics</span><span class="p">(</span>
                                <span class="n">content</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">directories</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span>
                                <span class="n">files_size</span><span class="p">,</span> <span class="n">path_size</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">links</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">directories</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">files_size</span><span class="p">,</span> <span class="n">path_size</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span>
                <span class="n">count</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DirectoriesCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directories</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">add_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">directory</span><span class="p">))</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">DirectoryAsDict</span><span class="o">.</span><span class="n">get_directory</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">[</span><span class="n">directory</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">st</span><span class="p">,</span> <span class="n">content</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">remove_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">[</span><span class="n">directory</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">has_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">directory</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">directories</span>

    <span class="k">def</span> <span class="nf">get_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">bz2</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bz2</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">directories</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">directories</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">directories</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="FileOrganizationModelManager"><a class="viewcode-back" href="../../api.html#soma.fom.FileOrganizationModelManager">[docs]</a><span class="k">class</span> <span class="nc">FileOrganizationModelManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Manage the discovery and instanciation of available FileOrganizationModel</span>
<span class="sd">    (FOM). A FOM can be represented as a YAML/JSON file (or a series of</span>
<span class="sd">    YAML/JSON files in a directory). This class allows to identify these files</span>
<span class="sd">    contained in a predefined set of directories (see find_fom method) and to</span>
<span class="sd">    instanciate a FileOrganizationModel for each identified file (see get_fom</span>
<span class="sd">    method).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create a FOM manager that will use the given paths to find available FOMs.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">paths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))),</span>
                              <span class="s1">&#39;share&#39;</span><span class="p">,</span> <span class="s1">&#39;foms&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="FileOrganizationModelManager.find_foms"><a class="viewcode-back" href="../../api.html#soma.fom.FileOrganizationModelManager.find_foms">[docs]</a>    <span class="k">def</span> <span class="nf">find_foms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a list of file organisation model (FOM) names.</span>
<span class="sd">        These FOMs can be loaded with load_foms. FOM files (or directories) are</span>
<span class="sd">        looked for in self.paths.&#39;&#39;&#39;</span>
        <span class="c1">#print(&#39;*** find_foms ***&#39;)</span>
        <span class="c1">#import time</span>
        <span class="c1">#t0 = time.time()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">paths</span><span class="p">:</span>
            <span class="c1"># print(&#39;   &#39;, path)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">full_path</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">):</span>
                            <span class="n">main_file</span> <span class="o">=</span> <span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">osp</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">main_file</span><span class="p">):</span>
                                <span class="n">d</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">main_file</span><span class="p">)</span>
                                <span class="n">name</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_name&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                        <span class="s1">&#39;file </span><span class="si">%s</span><span class="s1"> does not contain fom_name&#39;</span>
                                        <span class="o">%</span> <span class="n">main_file</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_path</span>
                    <span class="k">elif</span> <span class="n">i</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yaml&#39;</span><span class="p">):</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_name&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="s1">&#39;file </span><span class="si">%s</span><span class="s1"> does not contain fom_name&#39;</span>
                                    <span class="o">%</span> <span class="n">full_path</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_path</span>
        <span class="c1">#print(&#39;    find_foms done: %f s&#39; % (time.time() - t0))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

<div class="viewcode-block" id="FileOrganizationModelManager.fom_files"><a class="viewcode-back" href="../../api.html#soma.fom.FileOrganizationModelManager.fom_files">[docs]</a>    <span class="k">def</span> <span class="nf">fom_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a list of file organisation model (FOM) names, as in</span>
<span class="sd">        :meth:`find_foms`, but does not clear and reload the cache.</span>
<span class="sd">        These FOMs can be loaded with load_foms. FOM files (or directories) are</span>
<span class="sd">        looked for in self.paths.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_foms</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>

    <span class="k">def</span> <span class="nf">clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">load_foms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_foms</span><span class="p">()</span>
        <span class="n">foms</span> <span class="o">=</span> <span class="n">FileOrganizationModels</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">foms</span><span class="o">.</span><span class="n">import_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">foms_manager</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">foms</span>

    <span class="k">def</span> <span class="nf">file_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fom</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_foms</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">fom</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">read_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fom_name</span><span class="p">,</span> <span class="n">done</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">jsons</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="n">fom_name</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
            <span class="n">fom_name</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fom_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jsons</span><span class="p">:</span>
                <span class="n">json</span> <span class="o">=</span> <span class="n">jsons</span><span class="p">[</span><span class="n">fom_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="n">fom_name</span><span class="p">))</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_import&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">jsons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">jsons</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">jsons</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">json</span> <span class="ow">in</span> <span class="n">jsons</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;attribute_definitions&#39;</span><span class="p">,</span> <span class="s1">&#39;formats&#39;</span><span class="p">,</span> <span class="s1">&#39;format_lists&#39;</span><span class="p">,</span> <span class="s1">&#39;shared_patterns&#39;</span><span class="p">,</span> <span class="s1">&#39;patterns&#39;</span><span class="p">,</span> <span class="s1">&#39;processes&#39;</span><span class="p">):</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                    <span class="n">deep_update</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">{}))</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rules&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;rules&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span></div>


<span class="k">class</span> <span class="nc">FileOrganizationModels</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_directories_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;{([A-Za-z][A-Za-z0-9_]*)}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attributes_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;&lt;([^&gt;]+)&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fom_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attribute_definitions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fom_name&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;descr&quot;</span><span class="p">:</span> <span class="s2">&quot;File Organization Model (FOM) in which a pattern is defined.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fom_names</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;fom_format&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;descr&quot;</span><span class="p">:</span> <span class="s2">&quot;Format of a file.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;values&quot;</span><span class="p">:</span> <span class="nb">set</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_lists</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared_patterns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_expand_shared_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="n">expanded_pattern</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">last_end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_directories_regex</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">last_end</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">expanded_pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">expanded_pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_patterns</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>
            <span class="n">last_end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">expanded_pattern</span><span class="p">:</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">last_end</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
                <span class="n">expanded_pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expanded_pattern</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pattern</span>

    <span class="k">def</span> <span class="nf">import_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_or_dict</span><span class="p">,</span> <span class="n">foms_manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_or_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">file_or_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">json_dict</span> <span class="o">=</span> <span class="n">file_or_dict</span>

        <span class="n">foms</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_import&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">foms</span> <span class="ow">and</span> <span class="n">foms_manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s1">&#39;Cannot import FOM because no FileOrganizationModelManager has been provided&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fom</span> <span class="ow">in</span> <span class="n">foms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">import_file</span><span class="p">(</span>
                <span class="n">foms_manager</span><span class="o">.</span><span class="n">file_name</span><span class="p">(</span><span class="n">fom</span><span class="p">),</span> <span class="n">foms_manager</span><span class="o">=</span><span class="n">foms_manager</span><span class="p">)</span>

        <span class="n">fom_name</span> <span class="o">=</span> <span class="n">json_dict</span><span class="p">[</span><span class="s1">&#39;fom_name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fom_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fom_names</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fom_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fom_name</span><span class="p">)</span>

        <span class="c1"># Update attribute definitions</span>
        <span class="n">attribute_definitions</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attribute_definitions&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">attribute_definitions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">definition</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">attribute_definitions</span><span class="p">):</span>
                <span class="n">existing_definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">attribute</span><span class="p">)</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">existing_definition</span><span class="p">:</span>
                    <span class="n">existing_values</span> <span class="o">=</span> <span class="n">existing_definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">existing_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;Incompatible values redefinition for attribute </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attribute</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_value&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">existing_definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_value&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;Incompatible default value redefinition of attribute </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attribute</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                        <span class="n">existing_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">definition</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">values</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">definition</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">definition</span>

        <span class="c1"># Process shared patterns to expand the ones that reference other shared</span>
        <span class="c1"># patterns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">formats</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;formats&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format_lists</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format_lists&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shared_patterns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;shared_patterns&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_patterns</span><span class="p">:</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_patterns</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pattern</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                        <span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_shared_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">:</span>
                            <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_shared_pattern</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expanded_pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_shared_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">expanded_pattern</span> <span class="o">!=</span> <span class="n">pattern</span><span class="p">:</span>
                        <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">expanded_pattern</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">shared_patterns</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern</span>

        <span class="n">rules</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rules&#39;</span><span class="p">)</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;patterns&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="n">json_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;processes&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rules</span><span class="p">:</span>
            <span class="n">patterns</span><span class="p">[</span><span class="s1">&#39;fom_dummy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rules</span>
        <span class="n">new_patterns</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_expand_json_patterns</span><span class="p">(</span>
            <span class="n">patterns</span><span class="p">,</span> <span class="n">new_patterns</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fom_name&#39;</span><span class="p">:</span> <span class="n">fom_name</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_patterns</span><span class="p">(</span><span class="n">new_patterns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">processes</span><span class="p">:</span>
            <span class="n">process_patterns</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">process</span><span class="p">,</span> <span class="n">parameters</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">processes</span><span class="p">):</span>
                <span class="n">process_dict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">process_patterns</span><span class="p">[</span><span class="n">process</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_dict</span>
                <span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                        <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_patterns</span><span class="p">[</span><span class="n">rules</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">parameter_rules</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">process_dict</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter_rules</span>
                    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">pattern</span><span class="p">,</span> <span class="n">formats</span> <span class="o">=</span> <span class="n">rule</span>
                            <span class="n">rule_attributes</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">pattern</span><span class="p">,</span> <span class="n">formats</span><span class="p">,</span> <span class="n">rule_attributes</span> <span class="o">=</span> <span class="n">rule</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error in FOM: </span><span class="si">%s</span><span class="s1">, process: </span><span class="si">%s</span><span class="s1">, param: &#39;</span>
                                    <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, rule:&#39;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">fom_name</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">parameter</span><span class="p">),</span> <span class="n">rule</span><span class="p">)</span>
                                <span class="k">raise</span>
                        <span class="n">rule_attributes</span><span class="p">[</span><span class="s1">&#39;fom_process&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">process</span>
                        <span class="n">rule_attributes</span><span class="p">[</span><span class="s1">&#39;fom_parameter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter</span>
                        <span class="n">parameter_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">pattern</span><span class="p">,</span> <span class="n">formats</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">])</span>
            <span class="n">new_patterns</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_expand_json_patterns</span><span class="p">(</span>
                <span class="n">process_patterns</span><span class="p">,</span> <span class="n">new_patterns</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;fom_name&#39;</span><span class="p">:</span> <span class="n">fom_name</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_patterns</span><span class="p">(</span><span class="n">new_patterns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_attributes_without_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">att_no_value</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">att</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">att</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;shared.&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">attrec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shared_patterns</span><span class="p">[</span><span class="n">att</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">attrec</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">att_no_value</span><span class="p">:</span>
                        <span class="n">att_no_value</span><span class="p">[</span><span class="n">attrec</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">att_no_value</span>

    <span class="k">def</span> <span class="nf">selected_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">selection</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rule_pattern</span><span class="p">,</span> <span class="n">rule_attributes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;selected_rules: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">rule_pattern</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rule_attributes</span><span class="p">)))</span>
                <span class="n">rule_formats</span> <span class="o">=</span> <span class="n">rule_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_formats&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">format</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;fom_first&#39;</span><span class="p">,</span> <span class="s1">&#39;fom_preferred&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">rule_formats</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                    <span class="s1">&#39;selected_rules: -- no format in rule&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>
                    <span class="k">elif</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule_formats</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;selected_rules: -- format </span><span class="si">%s</span><span class="s1"> not in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span>
                                <span class="nb">format</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rule_formats</span><span class="p">)))</span>
                        <span class="k">continue</span>
                <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">selection_value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">attribute</span> <span class="o">==</span> <span class="s1">&#39;format&#39;</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">rule_value</span> <span class="o">=</span> <span class="n">rule_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rule_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rule_value</span> <span class="o">!=</span> <span class="n">selection_value</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;selected_rules: -- selection value </span><span class="si">%s</span><span class="s1"> != rule value </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                        <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">selection_value</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rule_value</span><span class="p">)))</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">keep</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;selected_rules: ++&#39;</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">rule_pattern</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">rule</span>

    <span class="k">def</span> <span class="nf">_expand_json_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_patterns</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">parent_attributes</span><span class="p">):</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">parent_attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json_patterns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_attributes&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">for</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">attributes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="p">[</span>
                    <span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">((</span><span class="n">value</span><span class="p">,))}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="p">[</span>
                    <span class="n">attribute</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
                <span class="n">values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">key_attribute</span> <span class="o">=</span> <span class="n">json_patterns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_key_attribute&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key_attribute</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key_attribute</span><span class="p">,</span> <span class="p">{})</span>
            <span class="c1"># raise ValueError( &#39;Attribute &quot;%s&quot; must be declared in</span>
            <span class="c1"># attribute_definitions&#39; % key_attribute )</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">json_patterns</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;fom_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;fom_dummy&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">key_attribute</span><span class="p">:</span>
                <span class="n">attributes</span><span class="p">[</span><span class="n">key_attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="p">[</span><span class="n">key_attribute</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_expand_json_patterns</span><span class="p">(</span>
                    <span class="n">value</span><span class="p">,</span> <span class="n">parent</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">()),</span> <span class="n">attributes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">parent</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">rules</span>
                <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">pattern</span><span class="p">,</span> <span class="n">format_list</span> <span class="o">=</span> <span class="n">rule</span>
                        <span class="n">rule_attributes</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pattern</span><span class="p">,</span> <span class="n">format_list</span><span class="p">,</span> <span class="n">rule_attributes</span> <span class="o">=</span> <span class="n">rule</span>
                        <span class="k">for</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">rule_attributes</span><span class="p">):</span>
                            <span class="n">definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                                <span class="n">attribute</span><span class="p">,</span> <span class="p">{})</span>
                            <span class="n">values</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
                            <span class="n">values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">attributes</span><span class="p">:</span>
                            <span class="n">new_attributes</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">new_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rule_attributes</span><span class="p">)</span>
                            <span class="n">rule_attributes</span> <span class="o">=</span> <span class="n">new_attributes</span>

                    <span class="c1"># Expand format_list</span>
                    <span class="n">rule_formats</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">format_list</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                        <span class="n">format_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">format_list</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">format_list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="n">format_list</span><span class="p">:</span>
                            <span class="n">formats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_lists</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">formats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">formats</span><span class="p">:</span>
                                    <span class="n">rule_formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">rule_formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>
                        <span class="n">rule_attributes</span><span class="p">[</span><span class="s1">&#39;fom_formats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rule_formats</span>

                    <span class="c1"># Expand patterns in rules</span>
                    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">expanded_pattern</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">last_end</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_directories_regex</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                            <span class="n">c</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">last_end</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
                            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                                <span class="n">expanded_pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                            <span class="n">attribute</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">expanded_pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">shared_patterns</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>
                            <span class="n">last_end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">expanded_pattern</span><span class="p">:</span>
                            <span class="n">last</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">last_end</span><span class="p">:]</span>
                            <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
                                <span class="n">expanded_pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
                            <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expanded_pattern</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pattern</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_parse_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">dest_patterns</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">patterns</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_patterns</span><span class="p">(</span>
                    <span class="n">value</span><span class="p">,</span> <span class="n">dest_patterns</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">()))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pattern_rules</span> <span class="o">=</span> <span class="n">dest_patterns</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                    <span class="n">pattern</span><span class="p">,</span> <span class="n">rule_attributes</span> <span class="o">=</span> <span class="n">rule</span>
                    <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span><span class="p">[:</span><span class="n">s</span><span class="p">]</span>
                        <span class="n">definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                            <span class="n">attribute</span><span class="p">,</span> <span class="p">{})</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">rule_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">definition</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="s1">&#39;fom_open_value&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">definition</span><span class="p">:</span>
                            <span class="n">definition</span><span class="p">[</span><span class="s1">&#39;fom_open_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="c1"># raise ValueError( &#39;Attribute &quot;%s&quot; must be</span>
                            <span class="c1"># declared in attribute_definitions&#39; % attribute )</span>
                        <span class="k">if</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">rule_attributes</span><span class="p">:</span>
                            <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                                <span class="s1">&#39;&lt;&#39;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">rule_attributes</span><span class="p">[</span><span class="s1">&#39;fom_directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                    <span class="n">pattern_rules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pattern</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pattern</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">pprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;fom_names&#39;</span><span class="p">,</span> <span class="s1">&#39;attribute_definitions&#39;</span><span class="p">,</span> <span class="s1">&#39;formats&#39;</span><span class="p">,</span> <span class="s1">&#39;format_lists&#39;</span><span class="p">,</span> <span class="s1">&#39;shared_patterns&#39;</span><span class="p">,</span> <span class="s1">&#39;patterns&#39;</span><span class="p">,</span> <span class="s1">&#39;rules&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
            <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">out</span><span class="p">)</span>


<div class="viewcode-block" id="PathToAttributes"><a class="viewcode-back" href="../../api.html#soma.fom.PathToAttributes">[docs]</a><span class="k">class</span> <span class="nc">PathToAttributes</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Utility class for file paths -&gt; attributes set transformation.</span>
<span class="sd">    Part of the FOM engine.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foms</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attributes_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;&lt;([^&gt;]+)&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_patterns</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rule_pattern</span><span class="p">,</span> <span class="n">rule_attributes</span> <span class="ow">in</span> <span class="n">foms</span><span class="o">.</span><span class="n">selected_rules</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
            <span class="n">rule_formats</span> <span class="o">=</span> <span class="n">rule_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_formats&#39;</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_patterns</span>
            <span class="n">attributes_found</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">splited_pattern</span> <span class="o">=</span> <span class="n">rule_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">splited_pattern</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">regex</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;^&#39;</span><span class="p">]</span>
                <span class="n">last_end</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes_regex</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">last_end</span><span class="p">:</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                        <span class="n">regex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                    <span class="n">attribute</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">attribute</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">attribute_re</span> <span class="o">=</span> <span class="n">attribute</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
                        <span class="n">attribute</span> <span class="o">=</span> <span class="n">attribute</span><span class="p">[:</span><span class="n">s</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">attribute_re</span> <span class="o">=</span> <span class="s1">&#39;[^/]*&#39;</span>
                    <span class="k">if</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">attributes_found</span><span class="p">:</span>
                        <span class="n">regex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;%(&#39;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s1">&#39;)s&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">attribute_type</span> <span class="o">=</span> <span class="n">foms</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
                        <span class="n">values</span> <span class="o">=</span> <span class="n">attribute_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;values&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">values</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">attribute_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_open_value&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
                            <span class="n">regex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s1">&#39;(?P&lt;</span><span class="si">%s</span><span class="s1">&gt;</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;(?:&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">regex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="s1">&#39;(?P&lt;</span><span class="si">%s</span><span class="s1">&gt;</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">attribute_re</span><span class="p">))</span>
                        <span class="n">attributes_found</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
                    <span class="n">last_end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">pattern</span><span class="p">[</span><span class="n">last_end</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">last</span><span class="p">:</span>
                    <span class="n">regex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">last</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">splited_pattern</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">rule_formats</span><span class="p">:</span>
                        <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="n">rule_formats</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">foms</span><span class="o">.</span><span class="n">formats</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;format &quot;</span><span class="si">%s</span><span class="s1">&quot; not if FOM &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span>
                                      <span class="o">%</span> <span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">foms</span><span class="o">.</span><span class="n">fom_names</span><span class="p">))</span>
                            <span class="n">extension</span> <span class="o">=</span> <span class="n">foms</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="n">rule_attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;fom_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">format</span>
                            <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fom_formats&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">parent</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">OrderedDict</span><span class="p">(),</span> <span class="n">OrderedDict</span><span class="p">()])[</span>
                                <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">parent</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">OrderedDict</span><span class="p">(),</span> <span class="n">OrderedDict</span><span class="p">()])[</span>
                            <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule_attributes</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">OrderedDict</span><span class="p">(),</span> <span class="n">OrderedDict</span><span class="p">()])[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">pprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pprint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_patterns</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_pprint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">indent</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">rules_subpattern</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="n">ext_rules</span><span class="p">,</span> <span class="n">subpattern</span> <span class="o">=</span> <span class="n">rules_subpattern</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: { (&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext_rules</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ext</span><span class="p">,</span> <span class="n">rules</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">ext_rules</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">*</span> \
                            <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rules</span><span class="p">),</span>
                          <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;},&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">,&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pprint</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">,</span> <span class="n">indent</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;),&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">parse_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirdict</span><span class="p">,</span> <span class="n">single_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">all_unknown</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dirdict</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">dirdict</span> <span class="o">=</span> <span class="n">DirectoryAsDict</span><span class="o">.</span><span class="n">paths_to_dict</span><span class="p">(</span><span class="n">dirdict</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_directory</span><span class="p">(</span><span class="n">dirdict</span><span class="p">,</span> <span class="p">[([],</span> <span class="bp">self</span><span class="o">.</span><span class="n">hierarchical_patterns</span><span class="p">,</span> <span class="p">{})],</span> <span class="n">single_match</span><span class="p">,</span> <span class="n">all_unknown</span><span class="p">,</span> <span class="n">log</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirdict</span><span class="p">,</span> <span class="n">parsing_list</span><span class="p">,</span> <span class="n">single_match</span><span class="p">,</span> <span class="n">all_unknown</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">dirdict</span><span class="p">):</span>
            <span class="n">st</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
            <span class="c1"># Split extention on left most dot</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">possible_extension_split</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">[:</span><span class="n">i</span><span class="p">]),</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">:]))</span>
                                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="c1"># split = name.split(&#39;.&#39;, 1)</span>
            <span class="c1"># name_no_ext = split[0]</span>
            <span class="c1"># if len(split) == 2:</span>
                <span class="c1"># ext = split[1]</span>
            <span class="c1"># else:</span>
                <span class="c1"># ext = &#39;&#39;</span>

            <span class="n">matched_directories</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">matched</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">sent</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">recurse_parsing_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">hierarchical_patterns</span><span class="p">,</span> <span class="n">pattern_attributes</span> <span class="ow">in</span> <span class="n">parsing_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;?? &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span>
                        <span class="n">pattern_attributes</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">hierarchical_patterns</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
                <span class="n">branch_matched</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">rules_subpattern</span> \
                        <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">hierarchical_patterns</span><span class="p">):</span>
                    <span class="n">stop_parsing</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">name_no_ext</span><span class="p">,</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">possible_extension_split</span><span class="p">:</span>
                        <span class="n">ext_rules</span><span class="p">,</span> <span class="n">subpattern</span> <span class="o">=</span> <span class="n">rules_subpattern</span>
                        <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span> <span class="o">%</span> <span class="n">pattern_attributes</span>
                        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">name_no_ext</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s1">&#39;try </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name_no_ext</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;match &#39;</span> <span class="o">+</span> <span class="n">pattern</span><span class="p">)</span>
                            <span class="n">new_attributes</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                            <span class="n">new_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pattern_attributes</span><span class="p">)</span>

                            <span class="n">rules</span> <span class="o">=</span> <span class="n">ext_rules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">subpattern</span> <span class="ow">and</span>
                                    <span class="ow">not</span> <span class="n">ext</span> <span class="ow">and</span>
                                    <span class="p">(</span><span class="n">st</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                     <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="ow">and</span>
                                    <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                                <span class="n">matched</span> <span class="o">=</span> <span class="n">branch_matched</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">stop_parsing</span> <span class="o">=</span> <span class="n">single_match</span>
                                <span class="n">full_path</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;directory matched: </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="nb">repr</span><span class="p">(</span><span class="n">full_path</span><span class="p">),</span> <span class="p">(</span><span class="nb">repr</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">content</span><span class="p">)])</span> <span class="k">if</span> <span class="n">content</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)))</span>
                                <span class="n">matched_directories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">,</span> <span class="n">new_attributes</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                        <span class="s1">&#39;no directory matched for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">rules</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ext</span><span class="p">:</span>
                                <span class="n">matched</span> <span class="o">=</span> <span class="n">branch_matched</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                        <span class="s1">&#39;extension matched: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ext</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">rule_attributes</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
                                    <span class="n">yield_attributes</span> <span class="o">=</span> <span class="n">new_attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                    <span class="n">yield_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rule_attributes</span><span class="p">)</span>
                                    <span class="n">stop_parsing</span> <span class="o">=</span> <span class="n">single_match</span> <span class="ow">or</span> <span class="n">yield_attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                                        <span class="s1">&#39;fom_stop_parsing&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                            <span class="s1">&#39;-&gt; &#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">yield_attributes</span><span class="p">))</span>
                                    <span class="n">sent</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="k">yield</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">st</span><span class="p">,</span> <span class="n">yield_attributes</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                        <span class="s1">&#39;no extension matched: &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ext</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">stop_parsing</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">stop_parsing</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">branch_matched</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">full_path</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">,</span> <span class="n">new_attributes</span> <span class="ow">in</span> <span class="n">matched_directories</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
                            <span class="n">recurse_parsing_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">subpattern</span><span class="p">,</span> <span class="n">new_attributes</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">recurse_parsing_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_directory</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">recurse_parsing_list</span><span class="p">,</span> <span class="n">single_match</span><span class="p">,</span> <span class="n">all_unknown</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">i</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">matched</span> <span class="ow">and</span> <span class="n">all_unknown</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-&gt; &#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; None&#39;</span><span class="p">)</span>
                <span class="n">sent</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">yield</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">st</span><span class="p">,</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_unknown_directory</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">log</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">i</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sent</span> <span class="ow">and</span> <span class="n">all_unknown</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;-&gt; &#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; None&#39;</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">st</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_parse_unknown_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirdict</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">log</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">dirdict</span><span class="p">):</span>
            <span class="n">st</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="n">content</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;?-&gt; &#39;</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; None&#39;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">st</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_unknown_directory</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">log</span><span class="p">):</span>
                    <span class="k">yield</span> <span class="n">i</span>

    <span class="k">def</span> <span class="nf">parse_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">single_match</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">dirdict</span> <span class="o">=</span> <span class="n">DirectoryAsDict</span><span class="o">.</span><span class="n">paths_to_dict</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">spath</span> <span class="o">=</span> <span class="n">split_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_directory</span><span class="p">(</span><span class="n">dirdict</span><span class="p">,</span> <span class="n">single_match</span><span class="o">=</span><span class="n">single_match</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">log</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">spath</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span></div>


<div class="viewcode-block" id="AttributesToPaths"><a class="viewcode-back" href="../../api.html#soma.fom.AttributesToPaths">[docs]</a><span class="k">class</span> <span class="nc">AttributesToPaths</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Utility class for attributes set -&gt; file paths transformation.</span>
<span class="sd">    Part of the FOM engine.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">foms</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directories</span><span class="o">=</span><span class="p">{},</span> <span class="n">preferred_formats</span><span class="o">=</span><span class="nb">set</span><span class="p">(),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">foms</span> <span class="o">=</span> <span class="n">foms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">directories</span> <span class="o">=</span> <span class="n">directories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;:memory:&#39;</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA journal_mode = OFF;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;PRAGMA synchronous = OFF;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">attribute_definitions</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s1">&#39;fom_formats&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;default_value&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span> <span class="k">if</span> <span class="s1">&#39;default_value&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">non_discriminant_attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">attribute_definitions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;discriminant&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">fom_format_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;fom_format&#39;</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;CREATE TABLE rules ( </span><span class="si">%s</span><span class="s1">, _fom_first, _fom_preferred_format, _fom_rule )&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                   <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;fom_first&#39;</span><span class="p">,</span> <span class="s1">&#39;fom_preferred_format&#39;</span><span class="p">)]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;CREATE INDEX rules_index ON rules (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;CREATE INDEX rules</span><span class="si">%s</span><span class="s1">_index ON rules (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">sql_insert</span> <span class="o">=</span> <span class="s1">&#39;INSERT INTO rules VALUES ( </span><span class="si">%s</span><span class="s1"> )&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="s1">&#39;?&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">rule_attributes</span> <span class="ow">in</span> <span class="n">foms</span><span class="o">.</span><span class="n">selected_rules</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;pattern: &#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rule_attributes</span><span class="p">))</span>
            <span class="n">pattern_attributes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">((</span><span class="n">i</span> <span class="k">if</span> <span class="s1">&#39;|&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">i</span> <span class="k">else</span> <span class="n">i</span><span class="p">[:</span> <span class="n">i</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)])</span>
                                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">_attributes_regex</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">rule_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">pattern_attributes</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&lt;([^&gt;|]*)(\|[^&gt;]*)?&gt;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;%(\1)s&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">),</span> <span class="n">rule_attributes</span><span class="p">))</span>
            <span class="n">fom_formats</span> <span class="o">=</span> <span class="n">rule_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_formats&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fom_formats</span> <span class="ow">and</span> <span class="s1">&#39;fom_format&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">rule_attributes</span><span class="p">:</span>
                <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="n">fom_formats</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">format</span> <span class="ow">in</span> <span class="n">preferred_formats</span><span class="p">:</span>
                        <span class="n">preferred_format</span> <span class="o">=</span> <span class="nb">format</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">preferred_format</span> <span class="o">=</span> <span class="n">fom_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="n">fom_formats</span><span class="p">:</span>
                    <span class="n">values</span><span class="p">[</span><span class="n">fom_format_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">format</span>
                    <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">first</span>
                    <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">format</span> <span class="o">==</span> <span class="n">preferred_format</span><span class="p">)</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_insert</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_insert</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_insert</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql_insert</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">find_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attributes</span><span class="o">=</span><span class="p">{},</span> <span class="n">debug</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;!find_path! </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">attributes</span><span class="p">))</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">d</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">d</span>
        <span class="n">select</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">selection_attributes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">default_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">default_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">default_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">default_values</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attribute</span><span class="p">,</span> <span class="n">default_value</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_discriminant_attributes</span><span class="p">:</span>
                        <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s1">&#39;(_&#39;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s2">&quot; IN (&#39;&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;) OR _&quot;</span> <span class="o">%</span> <span class="n">default_value</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s1">&#39; IS NULL )&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_discriminant_attributes</span><span class="p">:</span>
                        <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="s1">&#39;(_&#39;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s2">&quot; != &#39;&#39; OR _&quot;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s1">&#39; IS NULL )&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">attribute</span> <span class="o">==</span> <span class="s1">&#39;fom_format&#39;</span><span class="p">:</span>
                <span class="n">selected_format</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_format&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selected_format</span> <span class="o">==</span> <span class="s1">&#39;fom_first&#39;</span><span class="p">:</span>
                    <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_fom_first = 1&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">selected_format</span> <span class="o">==</span> <span class="s1">&#39;fom_preferred&#39;</span><span class="p">:</span>
                    <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_fom_preferred_format = 1&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s2">&quot; IN (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span>
                                  <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;?&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">))</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s2">&quot; = ?&quot;</span><span class="p">)</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_discriminant_attributes</span><span class="p">:</span>
                    <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s2">&quot; IN ( </span><span class="si">%s</span><span class="s2">, &#39;&#39; )&quot;</span> <span class="o">%</span>
                                  <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;?&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">value</span><span class="p">))</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">non_discriminant_attributes</span><span class="p">:</span>
                    <span class="n">select</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attribute</span> <span class="o">+</span> <span class="s2">&quot; IN ( ?, &#39;&#39; )&quot;</span><span class="p">)</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">selection_attributes</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_fom_rule&#39;</span><span class="p">,</span> <span class="s1">&#39;_fom_format&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">default_values</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT </span><span class="si">%s</span><span class="s1"> FROM rules WHERE </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns</span><span class="p">),</span> <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">select</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
            <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;!sql! </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
            <span class="n">rule_index</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="n">row</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="c1"># bool_output = False</span>
            <span class="n">rule</span><span class="p">,</span> <span class="n">rule_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">rule_index</span><span class="p">]</span>
            <span class="n">rule_attributes</span> <span class="o">=</span> <span class="n">rule_attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">default_attributes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">default_values</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">rule_attributes</span><span class="p">[</span>
                        <span class="n">default_values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">default_values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">default_attributes</span><span class="p">[</span>
                        <span class="n">default_values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">default_values</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># rule_attributes = self.foms.rules[ rule_index ][ 1 ].copy()</span>
            <span class="n">fom_formats</span> <span class="o">=</span> <span class="n">rule_attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fom_formats&#39;</span><span class="p">,</span> <span class="p">[])</span>

            <span class="c1"># if rule_attributes.get( &#39;fom_directory&#39; ) == &#39;output&#39;:</span>
                <span class="c1"># bool_output=True</span>

            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;!rule matching! </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="nb">repr</span><span class="p">((</span><span class="n">rule</span><span class="p">,</span> <span class="n">fom_formats</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span>
                <span class="n">rule_attributes</span><span class="p">[</span><span class="s1">&#39;fom_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">format</span>
                <span class="n">default_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">rule</span> <span class="o">%</span> <span class="n">default_attributes</span> <span class="o">+</span> <span class="n">ext</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                    <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;!single format! </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">format</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_directory</span><span class="p">(</span>
                    <span class="n">path</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">,</span>
                    <span class="n">selection_attributes</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;!--&gt;! </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
                    <span class="k">yield</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fom_formats</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fom_formats</span><span class="p">:</span>
                        <span class="n">ext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="n">f</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ext</span>
                        <span class="n">rule_attributes</span><span class="p">[</span><span class="s1">&#39;fom_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
                        <span class="n">default_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">path</span> <span class="o">=</span> <span class="n">rule</span> <span class="o">%</span> <span class="n">default_attributes</span> <span class="o">+</span> <span class="n">ext</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;!format from fom_formats! </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                        <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_directory</span><span class="p">(</span>
                            <span class="n">path</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">,</span>
                            <span class="n">selection_attributes</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                                <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;!--&gt;! </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
                            <span class="k">yield</span> <span class="n">r</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">default_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">path</span> <span class="o">=</span> <span class="n">rule</span> <span class="o">%</span> <span class="n">default_attributes</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;!no format! </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_directory</span><span class="p">(</span>
                        <span class="n">path</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">,</span>
                        <span class="n">selection_attributes</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                            <span class="n">debug</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;!--&gt;! </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
                        <span class="k">yield</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">find_discriminant_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">selection</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT DISTINCT &quot;</span><span class="si">%s</span><span class="s1">&quot; FROM rules&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attribute</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39; WHERE &#39;</span> <span class="o">+</span> \
                        <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s1">&#39; = ?&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">)</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span>
                                                   <span class="nb">list</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">values</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,)</span> <span class="ow">in</span> <span class="n">values</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">find_attributes_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">selection</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_attributes</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s1">&#39;SELECT DISTINCT &quot;</span><span class="si">%s</span><span class="s1">&quot; FROM rules&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attribute</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selection</span><span class="p">:</span>
                    <span class="n">sql</span> <span class="o">+=</span> <span class="s1">&#39; WHERE &#39;</span> <span class="o">+</span> \
                        <span class="s1">&#39; AND &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s1">&#39; = ?&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">)</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span>
                                                   <span class="nb">list</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
                <span class="n">result</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_join_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">rule_attributes</span><span class="p">,</span> <span class="n">selection_attributes</span><span class="p">):</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">selection_attributes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rule_attributes</span><span class="p">)</span>
        <span class="n">fom_directory</span> <span class="o">=</span> <span class="n">rule_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_directory&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fom_directory</span><span class="p">:</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">directories</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fom_directory</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">directory</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)),</span> <span class="n">attributes</span><span class="p">)</span>
                <span class="c1">#return (osp.join(directory, path), attributes)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)),</span> <span class="n">attributes</span><span class="p">)</span>
        <span class="c1">#return (path, attributes)</span>

    <span class="k">def</span> <span class="nf">allowed_formats_for_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process_name</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="n">formats</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rule</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_process&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">process_name</span> \
                    <span class="ow">and</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_parameter&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">param</span><span class="p">:</span>
                <span class="n">rformats</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fom_formats&#39;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">for</span> <span class="nb">format</span> <span class="ow">in</span> <span class="n">rformats</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">formats</span><span class="p">:</span>
                        <span class="n">formats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">format</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">formats</span>

<div class="viewcode-block" id="AttributesToPaths.allowed_extensions_for_parameter"><a class="viewcode-back" href="../../api.html#soma.fom.AttributesToPaths.allowed_extensions_for_parameter">[docs]</a>    <span class="k">def</span> <span class="nf">allowed_extensions_for_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Either formats or (process_name and param) should be passed</span>
<span class="sd">        kwargs</span>
<span class="sd">        ------</span>
<span class="sd">        formats: list of str</span>
<span class="sd">            if provided only this parameter will be used</span>
<span class="sd">        process_name: str</span>
<span class="sd">            name of the process</span>
<span class="sd">        param: str</span>
<span class="sd">            name of the process parameter</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;formats&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">formats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;formats&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="s1">&#39;process_name&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="s1">&#39;param&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">process_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;process_name&#39;</span><span class="p">]</span>
            <span class="n">param</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]</span>
            <span class="n">formats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_formats_for_parameter</span><span class="p">(</span><span class="n">process_name</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Either formats or (process_name and param) should &#39;</span>
                           <span class="s1">&#39;be passed&#39;</span><span class="p">)</span>
        <span class="n">exts</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">formats</span><span class="p">:</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="n">formats</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">formats</span> \
                    <span class="ow">and</span> <span class="nb">format</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">format_lists</span><span class="p">:</span>
                <span class="n">formats</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">format_lists</span><span class="p">[</span><span class="nb">format</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="n">exts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foms</span><span class="o">.</span><span class="n">formats</span><span class="p">[</span><span class="nb">format</span><span class="p">])</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">exts</span><span class="p">)</span></div></div>



<span class="k">def</span> <span class="nf">call_before_application_initialization</span><span class="p">(</span><span class="n">application</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="n">ListStr</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">enthought.traits.api</span> <span class="kn">import</span> <span class="n">ListStr</span>

    <span class="n">application</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
        <span class="s1">&#39;fom_path&#39;</span><span class="p">,</span>
        <span class="n">ListStr</span><span class="p">(</span><span class="n">descr</span><span class="o">=</span><span class="s1">&#39;Path for finding file organization models&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">application</span><span class="o">.</span><span class="n">install_directory</span><span class="p">:</span>
        <span class="n">application</span><span class="o">.</span><span class="n">fom_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">osp</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">application</span><span class="o">.</span><span class="n">install_directory</span><span class="p">,</span>
                                         <span class="s1">&#39;share&#39;</span><span class="p">,</span> <span class="s1">&#39;foms&#39;</span><span class="p">)]</span>


<span class="k">def</span> <span class="nf">call_after_application_initialization</span><span class="p">(</span><span class="n">application</span><span class="p">):</span>
    <span class="n">application</span><span class="o">.</span><span class="n">fom_manager</span> <span class="o">=</span> <span class="n">FileOrganizationModelManager</span><span class="p">(</span>
        <span class="n">application</span><span class="o">.</span><span class="n">fom_path</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">soma.application</span> <span class="kn">import</span> <span class="n">Application</span>
    <span class="c1"># First thing to do is to create an Application with name and version</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">Application</span><span class="p">(</span><span class="s1">&#39;soma.fom&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
    <span class="c1"># Register module to load and call functions before and/or after</span>
    <span class="c1"># initialization</span>
    <span class="n">app</span><span class="o">.</span><span class="n">plugin_modules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;soma.fom&#39;</span><span class="p">)</span>
    <span class="c1"># Application initialization (e.g. configuration file may be read here)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
    <span class="c1"># process_completion( sys.argv[1], {&#39;spm&#39; : &#39;/here/is/spm&#39;, &#39;shared&#39; :</span>
    <span class="c1"># &#39;/volatile/bouin/build/trunk/share/brainvisa-share-4.4&#39; })</span>

    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="c1"># logging.root.setLevel( logging.DEBUG )</span>
    <span class="n">fom</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">fom_manager</span><span class="o">.</span><span class="n">load_foms</span><span class="p">(</span><span class="s1">&#39;morphologist-brainvisa-pipeline-1.0&#39;</span><span class="p">)</span>
    <span class="c1"># atp = AttributesToPaths( fom, selection={ &#39;fom_process&#39;:&#39;morphologistSimp.SimplifiedMorphologist&#39; },</span>
                             <span class="c1"># preferred_formats=set( (&#39;NIFTI&#39;,) ),</span>
                             <span class="c1"># debug=logging )</span>
    <span class="c1"># form=&#39;MINC&#39;</span>
    <span class="c1"># form=&#39;,&#39;+&#39;MESH&#39;</span>
    <span class="c1"># print(&#39;form&#39;,form)</span>
    <span class="n">directories</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;input_directory&quot;</span><span class="p">:</span> <span class="s2">&quot;/input&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;output_directory&quot;</span><span class="p">:</span> <span class="s2">&quot;/output&quot;</span><span class="p">,</span>
                   <span class="s2">&quot;shared_directory&quot;</span><span class="p">:</span> <span class="s2">&quot;/shared&quot;</span><span class="p">}</span>
    <span class="n">fomr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NIFTI&#39;</span><span class="p">,</span> <span class="s1">&#39;MESH&#39;</span><span class="p">]</span>
    <span class="n">atp</span> <span class="o">=</span> <span class="n">AttributesToPaths</span><span class="p">(</span>
        <span class="n">fom</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;fom_process&#39;</span><span class="p">:</span> <span class="s1">&#39;morphologistPipeline.HeadMesh&#39;</span><span class="p">},</span>
        <span class="n">preferred_formats</span><span class="o">=</span><span class="n">fomr</span><span class="p">,</span> <span class="n">directories</span><span class="o">=</span><span class="n">directories</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="n">logging</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;protocol&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="s1">&#39;analysis&#39;</span><span class="p">:</span> <span class="s1">&#39;default_analysis&#39;</span><span class="p">,</span> <span class="s1">&#39;fom_parameter&#39;</span><span class="p">:</span> <span class="s1">&#39;head_mesh&#39;</span><span class="p">,</span>
        <span class="s1">&#39;acquisition&#39;</span><span class="p">:</span> <span class="s1">&#39;default_acquisition&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;002_S_0816_S18402_I40732&#39;</span><span class="p">,</span> <span class="s1">&#39;fom_format&#39;</span><span class="p">:</span> <span class="s1">&#39;fom_preferred&#39;</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atp</span><span class="o">.</span><span class="n">find_paths</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">logging</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>
    <span class="c1"># for parameter in fom.patterns[ &#39;morphologistSimp.SimplifiedMorphologist&#39; ]:</span>
        <span class="c1"># print(&#39;- %s&#39; % parameter)</span>
        <span class="c1"># for p, a in atp.find_paths( { &#39;fom_parameter&#39;: parameter,</span>
                                      <span class="c1">#&#39;protocol&#39;: &#39;c&#39;,</span>
                                      <span class="c1">#&#39;subject&#39;: &#39;s&#39;,</span>
                                      <span class="c1">#&#39;analysis&#39;: &#39;p&#39;,</span>
                                      <span class="c1">#&#39;acquisition&#39;: &#39;a&#39;,</span>
                                      <span class="c1">#&#39;fom_format&#39;: &#39;fom_preferred&#39;,</span>
                                <span class="c1">#} ):</span>
        <span class="c1"># print(&#39; &#39;, repr( p ), a)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Soma-base 5.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">soma.fom</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2011, IFR49.org.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.5.4.
    </div>
  </body>
</html>